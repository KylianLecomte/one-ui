<form (ngSubmit)="onSubmitTask()" [formGroup]="taskForm">
  <fieldset class="card">
    <legend>Création d'une tâche</legend>

    <cm-input-text
      [cssClassInput]="['default']"
      formControlName="name"
      id="name"
      label="Nom"
      labelPosition="top"
      placeholder="Nom"
    />
    <cm-textarea
      [cssClassInput]="['default']"
      formControlName="description"
      id="description"
      label="Description"
      labelPosition="top"
      placeholder="Description"
    ></cm-textarea>

    <cm-tabs [formGroup]="repetitionRuleForm">
      <cm-tab [label]="RepetitionLabels.WEEKLY">
        <ng-template>
          <cm-task-weekly-repetition
            [weeklyForm]="weeklyRepetitionRule"
          ></cm-task-weekly-repetition>
        </ng-template>
      </cm-tab>
      <cm-tab [label]="RepetitionLabels.MONTHLY"><ng-template>MONTHLY</ng-template></cm-tab>
      <cm-tab [label]="RepetitionLabels.FIX"><ng-template>FIX</ng-template></cm-tab>

      <div commonContent>
        <div class="ctn-start-repetition flex-row">
          <cm-date-picker
            [cssClassInput]="['default']"
            formControlName="startDate"
            id="startDate"
            label="Début"
            labelPosition="left"
          />
        </div>

        <div class="ctn-end-repetition flex-row">
          <cm-select
            [cssClassInput]="['default']"
            [options]="END_REPETITION"
            formControlName="endRepetitionType"
            id="repetitionEnd"
            label="Fin"
            labelPosition="left"
          ></cm-select>

          @if (endRepetitionValue === EndRepetition.DATE) {
            <cm-date-picker
              [cssClassInput]="['default']"
              formControlName="endDate"
              id="endDate"
              labelPosition="hidden"
            />
          } @else if (endRepetitionValue === EndRepetition.NB_OCCURENCE) {
            <cm-input-number
              [cssClassInput]="['default']"
              formControlName="endNbOccurence"
              id="endNbOccurence"
              labelPosition="hidden"
            ></cm-input-number>
          }
        </div>
        <div class="ctn-btn-add-repetition flex-row">
          <cm-button (click)="onAddRepetitionRule()" typeCss="complementary">{{
            labelBtnAddRule
          }}</cm-button>
          @if (this.selectedRepetitionRuleIndex() !== null) {
            <cm-button (click)="onCancelEditRepetitionRule()">Annuler</cm-button>
          }
        </div>
      </div>
    </cm-tabs>

    @for (repetitionRule of repetitionRules.controls; track $index) {
      <cm-task-repetition-rule
        (delete)="onDeleteRepetitionRule($index)"
        (select)="onEditRepetitionRule($index)"
        [isSelected]="selectedRepetitionRuleIndex() === $index"
        [repetitionRule]="repetitionRule.getRawValue()"
      ></cm-task-repetition-rule>
    }

    @if (selectedTask()) {
      <div class="task-form-buttons flex-row">
        <cm-button type="submit">Modifier</cm-button>
        <cm-button (click)="onCancelTask()">Annuler</cm-button>
      </div>
    } @else {
      <cm-button type="submit">Ajouter</cm-button>
    }
  </fieldset>
</form>
